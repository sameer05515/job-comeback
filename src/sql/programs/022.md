# Retrieve the top 2 customers by total purchase amount in each region.

```sql

-- Retrieve the top 2 customers by total purchase amount in each region.


CREATE TABLE customers (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  region VARCHAR(50)
);

CREATE TABLE purchases (
  id INT PRIMARY KEY,
  customerId INT,
  amount INT
);

INSERT INTO customers VALUES
(1, 'Clark', 'North'),
(2, 'Dave', 'North'),
(3, 'Ava', 'South'),
(4, 'Champa', 'South');

INSERT INTO purchases VALUES
(1, 1, 500),
(2, 1, 700),
(3, 2, 800),
(4, 3, 600),
(5, 3, 400),
(6, 4, 300);


-- using a window function with RANK() or DENSE_RANK().
-- We first sum purchases per customer, then rank within each region.

WITH customer_totals AS (
  SELECT c.id, c.name, c.region, SUM(p.amount) AS total_amount
  FROM customers c
  JOIN purchases p ON c.id = p.customerId
  GROUP BY c.id, c.name, c.region
),
ranked AS (
  SELECT ct.*, 
         RANK() OVER (PARTITION BY region ORDER BY total_amount DESC) AS rnk
  FROM customer_totals ct
)
SELECT id, name, region, total_amount
FROM ranked
WHERE rnk <= 2
ORDER BY region, rnk, name;

-- plain GROUP BY + correlated subquery version (no window functions, works on older MySQL/MariaDB)

-- Step 1: Calculate total purchase per customer
SELECT c.id, c.name, c.region, SUM(p.amount) AS total_amount
FROM customers c
JOIN purchases p ON c.id = p.customerId
GROUP BY c.id, c.name, c.region
HAVING (
   -- Step 2: Keep only customers who are in top 2 of their region
   SELECT COUNT(DISTINCT ct2.total_amount)
   FROM (
      SELECT c2.id, c2.region, SUM(p2.amount) AS total_amount
      FROM customers c2
      JOIN purchases p2 ON c2.id = p2.customerId
      WHERE c2.region = c.region
      GROUP BY c2.id, c2.region
   ) ct2
   WHERE ct2.total_amount > SUM(p.amount)
) < 2
ORDER BY c.region, total_amount DESC;






```


```
Output:

+----+--------+--------+--------------+
| id | name   | region | total_amount |
+----+--------+--------+--------------+
|  1 | Clark  | North  |         1200 |
|  2 | Dave   | North  |          800 |
|  3 | Ava    | South  |         1000 |
|  4 | Champa | South  |          300 |
+----+--------+--------+--------------+
+----+--------+--------+--------------+
| id | name   | region | total_amount |
+----+--------+--------+--------------+
|  1 | Clark  | North  |         1200 |
|  2 | Dave   | North  |          800 |
|  3 | Ava    | South  |         1000 |
|  4 | Champa | South  |          300 |
+----+--------+--------+--------------+

```